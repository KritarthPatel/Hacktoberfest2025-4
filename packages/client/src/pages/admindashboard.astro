---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import StatusMessage from '../components/StatusMessage.astro';
import UserTable from '../components/UserTable.astro';
import PRModal from '../components/PRModal.astro';
---

<Layout title="Admin Dashboard - GITGOPR">
  <Navbar />
  
  <main class="min-h-screen bg-black text-green-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="mb-8 flex justify-between items-start">
        <div>
          <h1 class="text-3xl font-bold text-green-400 font-mono mb-2">Admin Dashboard</h1>
          <p class="text-green-300 font-mono">Monitor user activity and PR statistics</p>
        </div>
        <button 
          id="refresh-all-btn" 
          class="bg-green-600 hover:bg-green-700 text-white font-mono px-6 py-3 rounded-lg transition duration-200 flex items-center gap-2"
        >
          <span id="refresh-icon">üîÑ</span>
          <span id="refresh-text">Refresh All PRs</span>
        </button>
      </div>

      <div id="loading" class="text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-400 mx-auto"></div>
        <p class="mt-4 text-green-300 font-mono">Loading dashboard data...</p>
      </div>

      <StatusMessage id="refresh-status" />

      <!-- Real-time Progress Display -->
      <div id="refresh-progress" class="hidden bg-gray-900 border border-green-600 rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-green-400 font-mono">Fetching PRs...</h3>
          <span id="progress-counter" class="text-green-300 font-mono text-sm">0 / 0</span>
        </div>
        <div class="w-full bg-gray-800 rounded-full h-4 mb-4">
          <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div id="current-user" class="text-green-300 font-mono text-sm flex items-center gap-2">
          <span class="animate-pulse">‚è≥</span>
          <span id="current-user-text">Preparing...</span>
        </div>
        <div id="progress-log" class="mt-4 max-h-48 overflow-y-auto space-y-1">
          <!-- Progress messages will be added here -->
        </div>
      </div>

      <div id="error" class="hidden bg-red-900 border border-red-600 rounded-lg p-4 mb-6">
        <p class="text-red-100 font-mono">Error loading data. Please try again.</p>
      </div>

      <div id="dashboard-content" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Total Users</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="total-users">-</p>
          </div>
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Total PRs</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="total-prs">-</p>
          </div>
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Open PRs</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="open-prs">-</p>
          </div>
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Merged PRs</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="merged-prs">-</p>
          </div>
        </div>

        <UserTable id="users-table-body" />
      </div>
    </div>

    <PRModal />
  </main>
</Layout>

<script>
  const API_BASE = import.meta.env.MODE == 'development' ? 'http://localhost:4000' : '';
  let adminPassword = localStorage.getItem('adminPassword') || '';

  // Check if admin is authenticated
  function checkAdminAuth() {
    if (!adminPassword) {
      const password = prompt('Enter admin password:');
      if (!password) {
        window.location.href = '/';
        return false;
      }
      adminPassword = password;
      localStorage.setItem('adminPassword', password);
    }
    return true;
  }




  interface User {
    _id: string;
    username: string;
    display_name: string | null;
    avatar_url: string | null;
    full_name: string | null;
    role: string | null;
    college: {
      _id: string;
      name: string;
    } | null;
    year: string | null;
    instructor: string | null;
    pr_count: number;
    github_prs: any[] | null;
  }

  interface PR {
    _id: string;
    pr_number: number;
    title: string;
    url: string;
    repository: {
      _id: string;
      name: string;
      owner: {
        _id: string;
        username: string;
      };
    };
    state: 'open' | 'closed' | 'merged';
    createdAt: string;
  }



  async function loadDashboardData() {
    if (!checkAdminAuth()) return;

    const loadingElem = document.getElementById('loading') as HTMLElement;
    const dashboardContent = document.getElementById('dashboard-content') as HTMLElement;
    const errorElem = document.getElementById('error') as HTMLElement;

    
    try {
      // Load stats with admin password
      const statsResponse = await fetch(API_BASE + '/api/admin/stats?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (statsResponse.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Invalid admin password. Please try again.');
        window.location.reload();
        return;
      }
      
      const stats = await statsResponse.json();

      const totalUsersElem = document.getElementById('total-users') as HTMLElement;
      const totalPRsElem = document.getElementById('total-prs') as HTMLElement;
      const openPRsElem = document.getElementById('open-prs') as HTMLElement;
      const mergedPRsElem = document.getElementById('merged-prs') as HTMLElement;

      totalUsersElem.textContent = stats.totalUsers;
      totalPRsElem.textContent = stats.totalPRs;
      openPRsElem.textContent = stats.openPRs;
      mergedPRsElem.textContent = stats.mergedPRs;

      const usersResponse = await fetch(API_BASE + '/api/admin/users?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (usersResponse.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Session expired. Please login again.');
        window.location.reload();
        return;
      }

      const usersData: { users: User[] } = await usersResponse.json();
      
      // Use template-based user table rendering
      const tableBody = document.querySelector('[data-user-table]') as HTMLElement;
      if (tableBody && window.populateUserTable) {
        window.populateUserTable(tableBody, usersData.users);
      }



      loadingElem.classList.add('hidden');
      dashboardContent.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      loadingElem.classList.add('hidden');
      errorElem.classList.remove('hidden');
    }
  }

  async function viewUserPRs(userId: string, username: string) {
    try {
      const adminPassword = localStorage.getItem('adminPassword') || '';
      const response = await fetch(API_BASE + '/api/admin/users/' + userId + '/prs?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (response.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Session expired. Please login again.');
        window.location.reload();
        return;
      }
      
      const data = await response.json();
      
      // Use template-based PR modal rendering
      const modalElement = document.querySelector('[data-pr-modal]') as HTMLElement;
      const titleElement = document.getElementById('modal-title') as HTMLElement;
      const contentElement = document.querySelector('[data-modal-content]') as HTMLElement;
      
      if (modalElement && titleElement && contentElement && window.populatePRModal) {
        window.populatePRModal(modalElement, titleElement, contentElement, username, data.prs);
      }
    } catch (error) {
      console.error('Error loading user PRs:', error);
    }
  }

  // Setup PR modal handlers using template component
  const modalElement = document.querySelector('[data-pr-modal]') as HTMLElement;
  if (modalElement && window.setupPRModalHandlers) {
    window.setupPRModalHandlers(modalElement);
  }

  // Track last processed position globally
  let lastProcessedCount = 0;

  // Manual refresh all PRs function with SSE and batch processing
  async function refreshAllPRs(skipCount = null) {
    const refreshBtn = document.getElementById('refresh-all-btn') as HTMLButtonElement;
    const refreshIcon = document.getElementById('refresh-icon') as HTMLElement;
    const refreshText = document.getElementById('refresh-text') as HTMLElement;
    const refreshStatus = document.getElementById('refresh-status') as HTMLElement;
    const progressContainer = document.getElementById('refresh-progress') as HTMLElement;
    const progressBar = document.getElementById('progress-bar') as HTMLElement;
    const progressCounter = document.getElementById('progress-counter') as HTMLElement;
    const currentUserText = document.getElementById('current-user-text') as HTMLElement;
    const progressLog = document.getElementById('progress-log') as HTMLElement;

    // Use last processed count if not explicitly provided
    if (skipCount === null) {
      skipCount = lastProcessedCount;
    }

    // Disable button and show loading state
    refreshBtn.disabled = true;
    refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
    refreshIcon.classList.add('animate-spin');
    refreshText.textContent = 'Refreshing...';
    
    // Show progress container (but don't clear log if resuming)
    progressContainer.classList.remove('hidden');
    if (skipCount === 0) {
      progressLog.innerHTML = '';
      lastProcessedCount = 0;
    }
    
    try {
      const adminPassword = localStorage.getItem('adminPassword') || '';
      const batchSize = 50; // Process 50 users at a time
      const eventSource = new EventSource(
        API_BASE + '/api/admin/refresh-all?adminPassword=' + encodeURIComponent(adminPassword) + 
        '&skip=' + skipCount + '&batchSize=' + batchSize
      );
      
      let totalUsersGlobal = 0;
      let processedGlobal = skipCount;
      
      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'start') {
          totalUsersGlobal = data.totalUsers;
        } else if (data.type === 'progress') {
          processedGlobal = skipCount + data.current;
          lastProcessedCount = processedGlobal; // Track progress
          const percentage = (processedGlobal / totalUsersGlobal) * 100;
          progressBar.style.width = `${percentage}%`;
          progressCounter.textContent = `${processedGlobal} / ${totalUsersGlobal}`;
          
          if (data.status === 'fetching') {
            currentUserText.textContent = `Fetching PRs for @${data.username}...`;
            const logEntry = document.createElement('div');
            logEntry.className = 'text-sm text-yellow-400 font-mono';
            logEntry.innerHTML = `<span class="animate-pulse">‚è≥</span> Fetching @${data.username}...`;
            progressLog.appendChild(logEntry);
          } else if (data.status === 'success') {
            const lastEntry = progressLog.lastElementChild;
            if (lastEntry) {
              lastEntry.className = 'text-sm text-green-400 font-mono';
              lastEntry.innerHTML = `<span>‚úì</span> @${data.username} - Done!`;
            }
          } else if (data.status === 'error') {
            const lastEntry = progressLog.lastElementChild;
            if (lastEntry) {
              lastEntry.className = 'text-sm text-red-400 font-mono';
              lastEntry.innerHTML = `<span>‚úó</span> @${data.username} - Error: ${data.error || 'Unknown error'}`;
            }
          }
          
          // Scroll to bottom of log
          progressLog.scrollTop = progressLog.scrollHeight;
        } else if (data.type === 'complete') {
          eventSource.close();
          
          // Check if there are more users to process
          if (data.hasMore && data.nextSkip) {
            currentUserText.textContent = `Batch complete! Continuing with next batch...`;
            
            // Add separator in log
            const separator = document.createElement('div');
            separator.className = 'text-sm text-blue-400 font-mono border-t border-blue-600 pt-2 mt-2';
            separator.textContent = `--- Continuing with users ${data.nextSkip + 1}+ ---`;
            progressLog.appendChild(separator);
            progressLog.scrollTop = progressLog.scrollHeight;
            
            // Auto-continue with next batch after 1 second
            setTimeout(() => {
              refreshAllPRs(data.nextSkip);
            }, 1000);
          } else {
            // All done!
            currentUserText.textContent = 'All users completed!';
            lastProcessedCount = 0; // Reset for next full refresh
            
            // Show success message
            if (window.showStatusMessage) {
              window.showStatusMessage(refreshStatus, {
                type: 'success',
                title: 'Refresh completed successfully!',
                message: 'All user PR data has been updated.',
                details: `Total processed: ${data.processed} users`
              });
            }
            
            // Reload dashboard data
            setTimeout(() => {
              loadDashboardData();
              progressContainer.classList.add('hidden');
            }, 2000);
            
            // Hide status after 5 seconds
            setTimeout(() => {
              if (window.hideStatusMessage) {
                window.hideStatusMessage(refreshStatus);
              }
            }, 5000);
            
            // Re-enable button
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            refreshIcon.classList.remove('animate-spin');
            refreshText.textContent = 'Refresh All PRs';
          }
        } else if (data.type === 'error') {
          eventSource.close();
          throw new Error(data.error || 'Unknown error');
        }
      };
      
      eventSource.onerror = (error) => {
        console.error('SSE Error:', error);
        eventSource.close();
        
        // Check if we received any progress - if so, it's a connection issue mid-stream
        const progressCounterText = progressCounter.textContent;
        const hasProgress = progressCounterText && progressCounterText !== '0 / 0';
        
        if (hasProgress) {
          if (window.showStatusMessage) {
            window.showStatusMessage(refreshStatus, {
              type: 'error',
              message: 'Connection interrupted. Progress was saved. Please click Refresh again to continue.'
            });
          }
        } else {
          if (window.showStatusMessage) {
            window.showStatusMessage(refreshStatus, {
              type: 'error',
              message: 'Error starting refresh. Please try again.'
            });
          }
        }
        
        // Re-enable button
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        refreshIcon.classList.remove('animate-spin');
        refreshText.textContent = 'Refresh All PRs';
        
        // Don't hide progress container if we made progress
        if (!hasProgress) {
          progressContainer.classList.add('hidden');
        }
      };
      
    } catch (error) {
      console.error('Error refreshing PRs:', error);
      if (window.showStatusMessage) {
        window.showStatusMessage(refreshStatus, {
          type: 'error',
          message: 'Error refreshing PRs. Please try again.'
        });
      }
      
      // Re-enable button
      refreshBtn.disabled = false;
      refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      refreshIcon.classList.remove('animate-spin');
      refreshText.textContent = 'Refresh All PRs';
      progressContainer.classList.add('hidden');
    }
  }

  // Add event listener to refresh button
  (document.getElementById('refresh-all-btn') as HTMLButtonElement).addEventListener('click', refreshAllPRs);

  loadDashboardData();

  declare global {
    interface Window {
      viewUserPRs: (userId: string, username: string) => void
    }
  }

  window.viewUserPRs = viewUserPRs;
</script>
