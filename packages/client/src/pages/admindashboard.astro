---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import StatusMessage from '../components/StatusMessage.astro';
import UserTable from '../components/UserTable.astro';
import PRModal from '../components/PRModal.astro';
---

<Layout title="Admin Dashboard - GITGOPR">
  <Navbar />
  
  <main class="min-h-screen bg-black text-green-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="mb-8 flex justify-between items-start">
        <div>
          <h1 class="text-3xl font-bold text-green-400 font-mono mb-2">Admin Dashboard</h1>
          <p class="text-green-300 font-mono">Monitor user activity and PR statistics</p>
        </div>
        <button 
          id="refresh-all-btn" 
          class="bg-green-600 hover:bg-green-700 text-white font-mono px-6 py-3 rounded-lg transition duration-200 flex items-center gap-2"
        >
          <span id="refresh-icon">üîÑ</span>
          <span id="refresh-text">Refresh All PRs</span>
        </button>
      </div>

      <div id="loading" class="text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-400 mx-auto"></div>
        <p class="mt-4 text-green-300 font-mono">Loading dashboard data...</p>
      </div>

      <StatusMessage id="refresh-status" />

      <!-- Real-time Progress Display -->
      <div id="refresh-progress" class="hidden bg-gray-900 border border-green-600 rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-green-400 font-mono">Fetching PRs...</h3>
          <span id="progress-counter" class="text-green-300 font-mono text-sm">0 / 0</span>
        </div>
        <div class="w-full bg-gray-800 rounded-full h-4 mb-4">
          <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div id="current-user" class="text-green-300 font-mono text-sm flex items-center gap-2">
          <span class="animate-pulse">‚è≥</span>
          <span id="current-user-text">Preparing...</span>
        </div>
        <div id="progress-log" class="mt-4 max-h-48 overflow-y-auto space-y-1">
          <!-- Progress messages will be added here -->
        </div>
      </div>

      <div id="error" class="hidden bg-red-900 border border-red-600 rounded-lg p-4 mb-6">
        <p class="text-red-100 font-mono">Error loading data. Please try again.</p>
      </div>

      <div id="dashboard-content" class="hidden">
        <!-- Search Box -->
        <div class="mb-6">
          <input 
            type="text" 
            id="user-search" 
            placeholder="Search users by name or username..." 
            class="w-full px-4 py-3 bg-gray-900 border border-green-600 rounded-lg text-green-100 font-mono focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Total Users</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="total-users">-</p>
          </div>
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Total PRs</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="total-prs">-</p>
          </div>
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Open PRs</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="open-prs">-</p>
          </div>
          <div class="bg-gray-900 border border-green-600 rounded-lg p-6">
            <p class="text-green-300 font-mono text-sm">Merged PRs</p>
            <p class="text-2xl font-bold text-green-100 font-mono" id="merged-prs">-</p>
          </div>
        </div>

        <UserTable id="users-table-body" />
      </div>
    </div>

    <PRModal />
    
    <!-- User Details Modal -->
    <div id="user-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-900 border border-green-600 rounded-lg p-6 w-full max-w-5xl max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h2 id="user-modal-title" class="text-xl font-bold text-green-100 font-mono">
              User Details
            </h2>
            <button 
              id="close-user-modal"
              class="text-green-300 hover:text-green-100 text-2xl font-bold"
              aria-label="Close modal"
            >
              √ó
            </button>
          </div>
          <div id="user-modal-content">
            <!-- User details will be populated here -->
            <div class="text-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-400 mx-auto mb-2"></div>
              <p class="text-green-300 font-mono">Loading user details...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  const API_BASE = import.meta.env.MODE == 'development' ? 'http://localhost:4000' : '';
  let adminPassword = localStorage.getItem('adminPassword') || '';

  // Check if admin is authenticated
  function checkAdminAuth() {
    if (!adminPassword) {
      const password = prompt('Enter admin password:');
      if (!password) {
        window.location.href = '/';
        return false;
      }
      adminPassword = password;
      localStorage.setItem('adminPassword', password);
    }
    return true;
  }




  interface User {
    _id: string;
    username: string;
    display_name: string | null;
    avatar_url: string | null;
    full_name: string | null;
    role: string | null;
    college: {
      _id: string;
      name: string;
    } | null;
    year: string | null;
    instructor: string | null;
    pr_count: number;
    github_prs: any[] | null;
  }

  interface PR {
    _id: string;
    pr_number: number;
    title: string;
    url: string;
    repository: {
      _id: string;
      name: string;
      owner: {
        _id: string;
        username: string;
      };
    };
    state: 'open' | 'closed' | 'merged';
    createdAt: string;
  }



  async function loadDashboardData() {
    if (!checkAdminAuth()) return;

    const loadingElem = document.getElementById('loading') as HTMLElement;
    const dashboardContent = document.getElementById('dashboard-content') as HTMLElement;
    const errorElem = document.getElementById('error') as HTMLElement;

    
    try {
      // Load stats with admin password
      const statsResponse = await fetch(API_BASE + '/api/admin/stats?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (statsResponse.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Invalid admin password. Please try again.');
        window.location.reload();
        return;
      }
      
      const stats = await statsResponse.json();

      const totalUsersElem = document.getElementById('total-users') as HTMLElement;
      const totalPRsElem = document.getElementById('total-prs') as HTMLElement;
      const openPRsElem = document.getElementById('open-prs') as HTMLElement;
      const mergedPRsElem = document.getElementById('merged-prs') as HTMLElement;

      totalUsersElem.textContent = stats.totalUsers;
      totalPRsElem.textContent = stats.totalPRs;
      openPRsElem.textContent = stats.openPRs;
      mergedPRsElem.textContent = stats.mergedPRs;

      const usersResponse = await fetch(API_BASE + '/api/admin/users?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (usersResponse.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Session expired. Please login again.');
        window.location.reload();
        return;
      }

      const usersData: { users: User[] } = await usersResponse.json();
      
      // Store users globally for search
      allUsers = usersData.users;
      
      // Use template-based user table rendering
      const tableBody = document.querySelector('[data-user-table]') as HTMLElement;
      if (tableBody && window.populateUserTable) {
        window.populateUserTable(tableBody, usersData.users);
      }
      
      // Wire up search input
      const searchInput = document.getElementById('user-search') as HTMLInputElement;
      if (searchInput) {
        searchInput.addEventListener('input', filterUsers);
      }



      loadingElem.classList.add('hidden');
      dashboardContent.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading dashboard data:', error);
      loadingElem.classList.add('hidden');
      errorElem.classList.remove('hidden');
    }
  }

  async function viewUserPRs(userId: string, username: string) {
    try {
      const adminPassword = localStorage.getItem('adminPassword') || '';
      const response = await fetch(API_BASE + '/api/admin/users/' + userId + '/prs?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (response.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Session expired. Please login again.');
        window.location.reload();
        return;
      }
      
      const data = await response.json();
      
      // Use template-based PR modal rendering
      const modalElement = document.querySelector('[data-pr-modal]') as HTMLElement;
      const titleElement = document.getElementById('modal-title') as HTMLElement;
      const contentElement = document.querySelector('[data-modal-content]') as HTMLElement;
      
      if (modalElement && titleElement && contentElement && window.populatePRModal) {
        window.populatePRModal(modalElement, titleElement, contentElement, username, data.prs);
      }
    } catch (error) {
      console.error('Error loading user PRs:', error);
    }
  }

  async function viewUserDetails(userId: string, username: string) {
    try {
      const adminPassword = localStorage.getItem('adminPassword') || '';
      const response = await fetch(API_BASE + '/api/admin/users/' + userId + '/prs?adminPassword=' + encodeURIComponent(adminPassword));
      
      if (response.status === 401) {
        localStorage.removeItem('adminPassword');
        alert('Session expired. Please login again.');
        window.location.reload();
        return;
      }
      
      const data = await response.json();
      const prs = data.prs || [];
      
      // Group PRs by organization and repository
      const orgStats: Record<string, Record<string, { total: number, merged: number, open: number, repos: Set<string> }>> = {};
      
      prs.forEach((pr: any) => {
        const owner = pr.repository?.owner?.username || 'Unknown';
        const repo = pr.repository?.name || 'Unknown';
        const repoFullName = `${owner}/${repo}`;
        
        if (!orgStats[owner]) {
          orgStats[owner] = {};
        }
        
        if (!orgStats[owner][repoFullName]) {
          orgStats[owner][repoFullName] = { total: 0, merged: 0, open: 0, repos: new Set() };
        }
        
        orgStats[owner][repoFullName].total++;
        if (pr.state === 'open') orgStats[owner][repoFullName].open++;
        // Note: we're storing state as 'open' or 'closed', not checking is_merged
        orgStats[owner][repoFullName].repos.add(repo);
      });
      
      // Build HTML
      const modal = document.getElementById('user-details-modal')!;
      const modalTitle = document.getElementById('user-modal-title')!;
      const modalContent = document.getElementById('user-modal-content')!;
      
      modalTitle.textContent = `${username} - Contribution Details`;
      
      let html = `
        <div class="space-y-6">
          <div class="bg-gray-800 border border-green-700 rounded-lg p-4">
            <h3 class="text-lg font-bold text-green-400 font-mono mb-4">Summary</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
              <div>
                <p class="text-2xl font-bold text-green-100 font-mono">${prs.length}</p>
                <p class="text-sm text-green-300 font-mono">Total PRs</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-green-100 font-mono">${Object.keys(orgStats).length}</p>
                <p class="text-sm text-green-300 font-mono">Organizations</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-green-100 font-mono">${Object.values(orgStats).reduce((sum, org) => sum + Object.keys(org).length, 0)}</p>
                <p class="text-sm text-green-300 font-mono">Repositories</p>
              </div>
            </div>
          </div>
      `;
      
      // List organizations and repositories
      if (Object.keys(orgStats).length > 0) {
        html += '<div class="space-y-4">';
        
        Object.entries(orgStats).sort((a, b) => 
          Object.keys(b[1]).length - Object.keys(a[1]).length
        ).forEach(([org, repos]) => {
          const totalPRsInOrg = Object.values(repos).reduce((sum, repo) => sum + repo.total, 0);
          
          html += `
            <div class="bg-gray-800 border border-green-700 rounded-lg p-4">
              <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-bold text-green-300 font-mono">üè¢ ${org}</h4>
                <span class="text-green-400 font-mono text-sm">${totalPRsInOrg} PRs</span>
              </div>
              <div class="space-y-2">
          `;
          
          Object.entries(repos).sort((a, b) => b[1].total - a[1].total).forEach(([repoName, stats]) => {
            html += `
              <div class="bg-gray-900 border border-green-800 rounded p-3 flex justify-between items-center">
                <div>
                  <a href="https://github.com/${repoName}" target="_blank" class="text-green-100 font-mono hover:text-green-300 transition-colors">
                    üì¶ ${repoName.split('/')[1]}
                  </a>
                </div>
                <div class="flex gap-4 text-sm font-mono">
                  <span class="text-green-400">${stats.total} PRs</span>
                  <span class="text-yellow-400">${stats.open} open</span>
                </div>
              </div>
            `;
          });
          
          html += '</div></div>';
        });
        
        html += '</div>';
      } else {
        html += '<p class="text-green-300 font-mono text-center py-8">No PRs found.</p>';
      }
      
      html += '</div>';
      
      modalContent.innerHTML = html;
      modal.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading user details:', error);
    }
  }

  // Setup PR modal handlers using template component
  const modalElement = document.querySelector('[data-pr-modal]') as HTMLElement;
  if (modalElement && window.setupPRModalHandlers) {
    window.setupPRModalHandlers(modalElement);
  }

  // Setup user details modal handlers
  const userModal = document.getElementById('user-details-modal')!;
  const closeUserModalBtn = document.getElementById('close-user-modal')!;
  
  closeUserModalBtn.addEventListener('click', () => {
    userModal.classList.add('hidden');
  });
  
  userModal.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).id === 'user-details-modal') {
      userModal.classList.add('hidden');
    }
  });

  // Polling interval for status updates
  let pollingInterval: number | null = null;
  let cooldownCheckInterval: number | null = null;

  // Check and update cooldown status
  async function checkCooldownStatus() {
    try {
      const adminPassword = localStorage.getItem('adminPassword') || '';
      const statusResponse = await fetch(API_BASE + '/api/admin/refresh-status?adminPassword=' + encodeURIComponent(adminPassword));
      const status = await statusResponse.json();
      
      const refreshBtn = document.getElementById('refresh-all-btn') as HTMLButtonElement;
      const refreshText = document.getElementById('refresh-text') as HTMLElement;
      
      if (status.lastCompletedTime) {
        const lastCompleted = new Date(status.lastCompletedTime).getTime();
        const cooldownMs = 10 * 60 * 60 * 1000; // 10 hours
        const remainingMs = (lastCompleted + cooldownMs) - Date.now();
        
        if (remainingMs > 0) {
          const hours = Math.floor(remainingMs / (60 * 60 * 1000));
          const minutes = Math.floor((remainingMs % (60 * 60 * 1000)) / (60 * 1000));
          
          refreshBtn.disabled = true;
          refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
          refreshText.textContent = `Cooldown: ${hours}h ${minutes}m`;
          return true; // On cooldown
        }
      }
      
      // Not on cooldown
      if (!status.isRunning) {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        refreshText.textContent = 'Refresh All PRs';
      }
      return false; // Not on cooldown
    } catch (error) {
      console.error('Error checking cooldown:', error);
      return false;
    }
  }

  // Manual refresh all PRs function with background job and polling
  async function refreshAllPRs() {
    const refreshBtn = document.getElementById('refresh-all-btn') as HTMLButtonElement;
    const refreshIcon = document.getElementById('refresh-icon') as HTMLElement;
    const refreshText = document.getElementById('refresh-text') as HTMLElement;
    const refreshStatus = document.getElementById('refresh-status') as HTMLElement;
    const progressContainer = document.getElementById('refresh-progress') as HTMLElement;
    const progressBar = document.getElementById('progress-bar') as HTMLElement;
    const progressCounter = document.getElementById('progress-counter') as HTMLElement;
    const currentUserText = document.getElementById('current-user-text') as HTMLElement;
    const progressLog = document.getElementById('progress-log') as HTMLElement;

    // Disable button and show loading state
    refreshBtn.disabled = true;
    refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
    refreshIcon.classList.add('animate-spin');
    refreshText.textContent = 'Starting...';
    
    // Show progress container and clear log
    progressContainer.classList.remove('hidden');
    progressLog.innerHTML = '';
    
    try {
      const adminPassword = localStorage.getItem('adminPassword') || '';
      
      // Start the background job
      const startResponse = await fetch(API_BASE + '/api/admin/refresh-all?adminPassword=' + encodeURIComponent(adminPassword), {
        method: 'POST'
      });
      
      if (!startResponse.ok) {
        throw new Error('Failed to start refresh');
      }
      
      const startData = await startResponse.json();
      if (!startData.success) {
        // Show cooldown message
        if (window.showStatusMessage) {
          window.showStatusMessage(refreshStatus, {
            type: 'error',
            message: startData.message || 'Failed to start refresh'
          });
        }
        
        // Re-enable button with cooldown text
        refreshBtn.disabled = true;
        refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
        refreshIcon.classList.remove('animate-spin');
        checkCooldownStatus();
        return;
      }
      
      refreshText.textContent = 'Refreshing...';
      let lastProcessed = 0;
      const seenUsers = new Set();
      
      // Poll for status updates
      pollingInterval = window.setInterval(async () => {
        try {
          const statusResponse = await fetch(API_BASE + '/api/admin/refresh-status?adminPassword=' + encodeURIComponent(adminPassword));
          const status = await statusResponse.json();
          
          // Update UI
          const percentage = status.totalUsers > 0 ? (status.processed / status.totalUsers) * 100 : 0;
          progressBar.style.width = `${percentage}%`;
          progressCounter.textContent = `${status.processed} / ${status.totalUsers}`;
          
          if (status.currentUser) {
            currentUserText.textContent = `Fetching PRs for @${status.currentUser}...`;
          }
          
          // Add new logs
          if (status.recentLogs && status.recentLogs.length > 0) {
            for (const log of status.recentLogs.slice().reverse()) {
              const key = `${log.username}-${log.status}`;
              if (!seenUsers.has(key)) {
                seenUsers.add(key);
                const logEntry = document.createElement('div');
                if (log.status === 'success') {
                  logEntry.className = 'text-sm text-green-400 font-mono';
                  logEntry.innerHTML = `<span>‚úì</span> @${log.username} - Done!`;
                } else {
                  logEntry.className = 'text-sm text-red-400 font-mono';
                  logEntry.innerHTML = `<span>‚úó</span> @${log.username} - Error: ${log.error || 'Unknown error'}`;
                }
                progressLog.appendChild(logEntry);
              }
            }
            progressLog.scrollTop = progressLog.scrollHeight;
          }
          
          // Check if complete
          if (!status.isRunning && status.processed > 0) {
            clearInterval(pollingInterval!);
            currentUserText.textContent = 'All users completed!';
            
            // Show success message
            if (window.showStatusMessage) {
              window.showStatusMessage(refreshStatus, {
                type: 'success',
                title: 'Refresh completed successfully!',
                message: 'All user PR data has been updated.',
                details: `Successful: ${status.successful} | Errors: ${status.errors}`
              });
            }
            
            // Reload dashboard data
            setTimeout(() => {
              loadDashboardData();
              progressContainer.classList.add('hidden');
            }, 2000);
            
            // Re-enable button
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            refreshIcon.classList.remove('animate-spin');
            refreshText.textContent = 'Refresh All PRs';
            
            // Start cooldown checker
            cooldownCheckInterval = window.setInterval(checkCooldownStatus, 60000); // Check every minute
          }
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, 1000); // Poll every second
      
    } catch (error) {
      console.error('Error starting refresh:', error);
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      if (window.showStatusMessage) {
        window.showStatusMessage(refreshStatus, {
          type: 'error',
          message: 'Error starting refresh. Please try again.'
        });
      }
      
      // Re-enable button
      refreshBtn.disabled = false;
      refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      refreshIcon.classList.remove('animate-spin');
      refreshText.textContent = 'Refresh All PRs';
      progressContainer.classList.add('hidden');
    }
  }

  // Add event listener to refresh button
  (document.getElementById('refresh-all-btn') as HTMLButtonElement).addEventListener('click', refreshAllPRs);

  // Check cooldown status on load and every minute
  checkCooldownStatus();
  cooldownCheckInterval = window.setInterval(checkCooldownStatus, 60000);

  loadDashboardData();

  // Store all users for search filtering
  let allUsers: any[] = [];

  // Search functionality
  function filterUsers() {
    const searchInput = document.getElementById('user-search') as HTMLInputElement;
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (!searchTerm) {
      // Show all users if search is empty
      const tableBody = document.querySelector('[data-user-table]') as HTMLElement;
      if (tableBody && window.populateUserTable) {
        window.populateUserTable(tableBody, allUsers);
      }
      return;
    }
    
    // Filter users by name or username
    const filtered = allUsers.filter(user => {
      const fullName = (user.full_name || '').toLowerCase();
      const username = (user.username || '').toLowerCase();
      const displayName = (user.display_name || '').toLowerCase();
      
      return fullName.includes(searchTerm) || 
             username.includes(searchTerm) || 
             displayName.includes(searchTerm);
    });
    
    // Update table with filtered users
    const tableBody = document.querySelector('[data-user-table]') as HTMLElement;
    if (tableBody && window.populateUserTable) {
      window.populateUserTable(tableBody, filtered);
    }
  }

  declare global {
    interface Window {
      viewUserPRs: (userId: string, username: string) => void
      viewUserDetails: (userId: string, username: string) => void
    }
  }

  window.viewUserPRs = viewUserPRs;
  window.viewUserDetails = viewUserDetails;
</script>
